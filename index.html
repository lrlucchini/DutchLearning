<!DOCTYPE html>
<html>
<head>
<title>Dutch Verb Practice</title>
<style>
    body {
        font-family: sans-serif;
        line-height: 1.6;
        background-color: #f4f4f4;
        color: #333;
        padding: 20px;
    }
    .container {
        max-width: 600px;
        margin: 20px auto;
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
        color: #0056b3;
        text-align: center;
        margin-bottom: 30px;
    }
    #difficulty-container, #tense-select-container, #question-container, #feedback-container {
        margin-bottom: 25px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
    }
    #difficulty-container span, #feedback-container span {
        font-weight: bold;
        color: #0056b3;
    }
    label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
    }
    select, input[type="radio"] {
        margin-right: 5px;
    }
    select {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        width: 100%; /* Make select responsive */
        box-sizing: border-box; /* Include padding and border in element's total width and height */
    }
    .options-container label {
        display: block;
        margin-bottom: 12px;
        padding: 10px;
        border: 1px solid #eee;
        border-radius: 4px;
        background-color: #fff;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
    }
    .options-container label:hover {
        background-color: #e9ecef;
    }
    #feedback {
        margin-top: 15px;
        font-weight: bold;
        padding: 10px;
        border-radius: 4px;
    }
    .correct {
        color: #155724;
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
    }
    .incorrect {
        color: #721c24;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
    }
    #verb-info {
        font-style: italic;
        color: #555;
        font-size: 0.9em;
    }
</style>
</head>
<body>
<div class="container">
    <h1>Dutch Verb Practice</h1>

    <div id="difficulty-container">
        Difficulty Level: <span id="current-difficulty">1</span><br>
        Progress: <span id="level-progress">0</span> / <span id="level-threshold">5</span>
    </div>

    <div id="tense-select-container">
        <label for="tense-select">Choose a form to practice:</label>
        <select id="tense-select">
            <option value="present_singular_3rd">Present (hij/zij/het form)</option>
            <option value="simple_past_singular">Past Simple (ik/hij form)</option>
            <option value="past_participle">Perfect Participle</option>
        </select>
    </div>

    <div id="question-container">
        <p><strong>Verb:</strong> <span id="verb-infinitive"></span></p>
        <p><strong>English Meaning:</strong> <span id="english-meaning"></span></p>
        <p id="verb-info"></p> <label>Choose the correct form:</label>
        <div class="options-container" id="options-container">
            </div>
    </div>

    <div id="feedback-container">
        <p id="feedback"></p>
        <p>Overall Score: <span id="overall-score">0</span></p>
    </div>

    <div id="message-area" style="text-align: center; padding: 20px; color: red;"></div>

</div>

<script>
    // Global variable to hold the loaded verb library
    let verbLibrary = [];
    let currentVerb;
    let currentTenseField; // Stores the field name like 'present_singular_3rd'
    let correctOptionValue; // Stores the correct verb form string

    // Score and difficulty tracking
    let overallScore = 0;
    let currentDifficulty = 0; // Start at level 0
    let correctInLevel = 0;
    const levelThreshold = 5; // Number of correct answers to advance level
    const maxDifficulty = 5; // Highest difficulty level in the JSON

    // DOM Elements
    const tenseSelect = document.getElementById("tense-select");
    const optionsContainer = document.getElementById("options-container");
    const feedbackEl = document.getElementById("feedback");
    const overallScoreEl = document.getElementById("overall-score");
    const currentDifficultyEl = document.getElementById("current-difficulty");
    const levelProgressEl = document.getElementById("level-progress");
    const levelThresholdEl = document.getElementById("level-threshold");
    const verbInfinitiveEl = document.getElementById("verb-infinitive");
    const englishMeaningEl = document.getElementById("english-meaning");
    const verbInfoEl = document.getElementById("verb-info");
    const messageArea = document.getElementById("message-area");
    const questionContainer = document.getElementById("question-container");


    /**
     * Loads the verb library from the JSON file.
     */
    async function loadVerbLibrary() {
        messageArea.textContent = "Loading verb library...";
        try {
            const response = await fetch('dutchverbslibrary.json');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            verbLibrary = await response.json();
            console.log(`Successfully loaded ${verbLibrary.length} verbs.`);
            messageArea.textContent = ""; // Clear loading message
            initializeApp(); // Start the app only after data is loaded
        } catch (error) {
            console.error('Could not load verb library:', error);
            messageArea.textContent = `Error loading verb library: ${error.message}. Please ensure dutchverbslibrary.json is in the same directory.`;
            // Disable UI elements if loading fails
            tenseSelect.disabled = true;
        }
    }

    /**
     * Initializes the application state and loads the first question.
     * Called after the verb library is successfully loaded.
     */
    function initializeApp() {
        levelThresholdEl.textContent = levelThreshold;
        currentDifficultyEl.textContent = currentDifficulty;
        levelProgressEl.textContent = correctInLevel;
        overallScoreEl.textContent = overallScore;
        tenseSelect.disabled = false; // Ensure select is enabled
        loadQuestion(); // Load the first question
    }

    /**
     * Loads a new verb question based on current difficulty and selected tense.
     */
    function loadQuestion() {
        // Filter verbs for the current difficulty level
        let filteredVerbs = verbLibrary.filter(verb => verb.difficulty_level === currentDifficulty);

        // If no verbs at current level (or level completed), try to advance
        if (filteredVerbs.length === 0) {
            if (currentDifficulty < maxDifficulty) {
                currentDifficulty++;
                currentDifficultyEl.textContent = currentDifficulty;
                correctInLevel = 0; // Reset progress for new level
                levelProgressEl.textContent = correctInLevel;
                console.log(`Advanced to difficulty level ${currentDifficulty}`);
                // Re-filter for the new level
                filteredVerbs = verbLibrary.filter(verb => verb.difficulty_level === currentDifficulty);
                 // Check if there are verbs at the new level
                if (filteredVerbs.length === 0) {
                    console.warn(`No verbs found for difficulty level ${currentDifficulty} either.`);
                     // Handle case where even the next level has no verbs (maybe end of data)
                    if (currentDifficulty >= maxDifficulty) {
                        displayCompletionMessage();
                        return;
                    }
                    // Potentially skip this level if empty, or display an error/message
                    // For now, let's assume levels have verbs or we hit maxDifficulty
                }
            } else {
                // Already at max difficulty and no verbs found (shouldn't happen if maxDifficulty is correct)
                // Or, user completed the max difficulty level in the previous step
                displayCompletionMessage();
                return;
            }
        }

         // If after advancing we still have no verbs (e.g., skipped an empty level and next is also empty/max)
        if (filteredVerbs.length === 0) {
             displayCompletionMessage(); // Or handle differently
             return;
        }


        // Select a random verb from the filtered list
        currentVerb = filteredVerbs[Math.floor(Math.random() * filteredVerbs.length)];
        currentTenseField = tenseSelect.value; // e.g., 'present_singular_3rd'

        // Get the correct answer string from the current verb object
        correctOptionValue = currentVerb[currentTenseField];

        // Display verb info
        verbInfinitiveEl.textContent = currentVerb.infinitive;
        englishMeaningEl.textContent = currentVerb.translation;

        // Display auxiliary verb info if practicing past participle
        if (currentTenseField === 'past_participle') {
            verbInfoEl.textContent = `(Auxiliary: ${currentVerb.auxiliary_verb || 'N/A'})`;
        } else {
            verbInfoEl.textContent = ''; // Clear info for other tenses
        }


        // Generate options (1 correct, 4 incorrect)
        const options = [correctOptionValue];
        const numOptions = 5;

        // Get distractors (same form, different verbs from the *same difficulty level*)
        let attempts = 0; // Prevent infinite loop
        while (options.length < numOptions && attempts < 20) {
            const randomVerbIndex = Math.floor(Math.random() * filteredVerbs.length);
            const randomVerb = filteredVerbs[randomVerbIndex];
            // Ensure we don't pick the same verb again for distractors if possible
            if (randomVerb.verb_id === currentVerb.verb_id && filteredVerbs.length > 1) {
                attempts++;
                continue;
            }
            const randomOption = randomVerb[currentTenseField];

            // Add if it's a valid option and not already included
            if (randomOption && !options.includes(randomOption)) {
                options.push(randomOption);
            }
            attempts++;
        }

        // If we still don't have enough options (e.g., few verbs at this level), fill with placeholders or duplicates if necessary
         while (options.length < numOptions) {
             options.push(`Option ${options.length + 1}`); // Placeholder
             console.warn("Could not generate enough unique distractors.");
         }


        shuffleArray(options);

        // Display options as radio buttons
        optionsContainer.innerHTML = ""; // Clear previous options
        options.forEach((option) => {
            const label = document.createElement("label");
            const radio = document.createElement("input");
            radio.type = "radio";
            radio.name = "verb-option";
            radio.value = option;
            radio.addEventListener("change", handleAnswerSelection); // Changed event listener
            label.appendChild(radio);
            label.appendChild(document.createTextNode(option || 'N/A')); // Handle null/undefined options gracefully
            optionsContainer.appendChild(label);
        });

        // Clear previous feedback
        feedbackEl.textContent = "";
        feedbackEl.className = ""; // Remove color classes
    }

    /**
     * Shuffles array elements in place.
     * @param {Array} array Array to shuffle.
     */
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]]; // ES6 swap
        }
    }

    /**
      * Handles the selection of an answer and triggers checking.
      * Added this intermediate step for clarity and potential future use (e.g., submit button)
      */
    function handleAnswerSelection() {
        checkAnswer();
    }


    /**
     * Checks the selected answer against the correct option.
     */
    function checkAnswer() {
        const selectedOption = document.querySelector('input[name="verb-option"]:checked');
        if (selectedOption) {
            const userAnswer = selectedOption.value;

            // Direct comparison with the stored correct option string
            if (userAnswer === correctOptionValue) {
                feedbackEl.textContent = "Correct!";
                feedbackEl.className = "correct"; // Add green background
                overallScore++;
                correctInLevel++;
                overallScoreEl.textContent = overallScore;
                levelProgressEl.textContent = correctInLevel;

                // Check for level advancement
                if (correctInLevel >= levelThreshold) {
                    if (currentDifficulty < maxDifficulty) {
                        // currentDifficulty++; // Increment happens in loadQuestion now
                        // currentDifficultyEl.textContent = currentDifficulty;
                        // correctInLevel = 0; // Reset happens in loadQuestion now
                        // levelProgressEl.textContent = correctInLevel;
                        feedbackEl.textContent += " Level complete! Moving to the next difficulty level!";
                        // Let loadQuestion handle the actual level increment and re-filtering
                    } else {
                        // Completed the final level
                        displayCompletionMessage();
                        return; // Stop further processing
                    }
                }
            } else {
                feedbackEl.textContent = `Incorrect. The correct answer is: ${correctOptionValue}`;
                feedbackEl.className = "incorrect"; // Add red background
            }

            // Disable options after answering
            document.querySelectorAll('input[name="verb-option"]').forEach(radio => radio.disabled = true);


            // Automatically load the next question after a short delay
            setTimeout(loadQuestion, 1500); // Increased delay to read feedback
        }
    }

    /**
     * Displays the completion message.
     */
     function displayCompletionMessage() {
         questionContainer.innerHTML = "<h2>Congratulations! You have completed all available difficulty levels.</h2>";
         tenseSelect.disabled = true; // Disable further changes
         feedbackEl.textContent = "Finished!";
         feedbackEl.className = "correct";
     }


    // Event Listeners
    tenseSelect.addEventListener("change", () => {
        // Reset level progress if tense changes? Optional, maybe not desired.
        // correctInLevel = 0;
        // levelProgressEl.textContent = correctInLevel;
        loadQuestion(); // Load a new question for the selected tense
    });

    // Start loading the verb library when the DOM is ready
    document.addEventListener("DOMContentLoaded", loadVerbLibrary);

</script>

</body>
</html>
