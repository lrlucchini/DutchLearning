<!DOCTYPE html>
<html>
<head>
<title>Dutch Verb Practice</title>
<style>
    body {
        font-family: sans-serif;
        line-height: 1.6;
        background-color: #f4f4f4;
        color: #333;
        padding: 20px;
    }
    .container {
        max-width: 600px;
        margin: 20px auto;
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
        color: #0056b3;
        text-align: center;
        margin-bottom: 30px;
    }
    #difficulty-container, #tense-select-container, #question-container, #feedback-container {
        margin-bottom: 25px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
    }
    #difficulty-container span, #feedback-container span, #verb-difficulty { /* Added verb-difficulty */
        font-weight: bold;
        color: #0056b3;
    }
    label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
    }
    select, input[type="radio"] {
        margin-right: 5px;
    }
    select {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        width: 100%; /* Make select responsive */
        box-sizing: border-box; /* Include padding and border in element's total width and height */
    }
    .options-container label {
        display: block;
        margin-bottom: 12px;
        padding: 10px;
        border: 1px solid #eee;
        border-radius: 4px;
        background-color: #fff;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
    }
    .options-container label:hover {
        background-color: #e9ecef;
    }
    /* Style for selected radio button label */
    .options-container input[type="radio"]:checked + span {
       font-weight: bold;
       /* Add other styles if desired */
    }
    #feedback {
        margin-top: 15px;
        font-weight: bold;
        padding: 10px;
        border-radius: 4px;
    }
    .correct {
        color: #155724;
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
    }
    .incorrect {
        color: #721c24;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
    }
    #verb-info {
        font-style: italic;
        color: #555;
        font-size: 0.9em;
    }
    /* Style for the verb difficulty display */
    .verb-details p {
        margin: 5px 0; /* Add some spacing between verb details */
    }
</style>
</head>
<body>
<div class="container">
    <h1>Dutch Verb Practice</h1>

    <div id="difficulty-container">
        App Difficulty Level: <span id="current-difficulty">0</span><br> Progress: <span id="level-progress">0</span> / <span id="level-threshold">5</span>
    </div>

    <div id="tense-select-container">
        <label for="tense-select">Choose a form to practice:</label>
        <select id="tense-select">
            <option value="present_singular_3rd">Present (hij/zij/het form)</option>
            <option value="simple_past_singular">Past Simple (ik/hij form)</option>
            <option value="past_participle">Perfect Participle</option>
        </select>
    </div>

    <div id="question-container">
        <div class="verb-details">
             <p><strong>Verb:</strong> <span id="verb-infinitive"></span></p>
             <p><strong>English Meaning:</strong> <span id="english-meaning"></span></p>
             <p><strong>Verb Difficulty:</strong> <span id="verb-difficulty"></span></p> <p id="verb-info"></p> </div>
        <hr> <label>Choose the correct form:</label>
        <div class="options-container" id="options-container">
            </div>
    </div>

    <div id="feedback-container">
        <p id="feedback"></p>
        <p>Overall Score: <span id="overall-score">0</span></p>
    </div>

    <div id="message-area" style="text-align: center; padding: 20px; color: red;"></div>

</div>

<script>
    // Global variable to hold the loaded verb library
    let verbLibrary = [];
    let currentVerb;
    let currentTenseField; // Stores the field name like 'present_singular_3rd'
    let correctOptionValue; // Stores the correct verb form string

    // Score and difficulty tracking
    let overallScore = 0;
    let currentDifficulty = 0; // Start at level 0
    let correctInLevel = 0;
    const levelThreshold = 5; // Number of correct answers to advance level
    const maxDifficulty = 5; // Highest difficulty level in the JSON

    // DOM Elements Cache
    const tenseSelect = document.getElementById("tense-select");
    const optionsContainer = document.getElementById("options-container");
    const feedbackEl = document.getElementById("feedback");
    const overallScoreEl = document.getElementById("overall-score");
    const currentDifficultyEl = document.getElementById("current-difficulty");
    const levelProgressEl = document.getElementById("level-progress");
    const levelThresholdEl = document.getElementById("level-threshold");
    const verbInfinitiveEl = document.getElementById("verb-infinitive");
    const englishMeaningEl = document.getElementById("english-meaning");
    const verbDifficultyEl = document.getElementById("verb-difficulty"); // Added cache for verb difficulty
    const verbInfoEl = document.getElementById("verb-info");
    const messageArea = document.getElementById("message-area");
    const questionContainer = document.getElementById("question-container");


    /**
     * Loads the verb library from the JSON file using fetch.
     */
    async function loadVerbLibrary() {
        messageArea.textContent = "Loading verb library...";
        try {
            const response = await fetch('dutchverbslibrary.json');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            verbLibrary = await response.json();
            console.log(`Successfully loaded ${verbLibrary.length} verbs.`);
            messageArea.textContent = "";
            initializeApp();
        } catch (error) {
            console.error('Could not load verb library:', error);
            messageArea.textContent = `Error loading verb library: ${error.message}. Please ensure dutchverbslibrary.json is in the same directory and is valid JSON.`;
            tenseSelect.disabled = true;
            questionContainer.innerHTML = "<p>Could not load questions.</p>";
        }
    }

    /**
     * Initializes the application state and loads the first question.
     */
    function initializeApp() {
        levelThresholdEl.textContent = levelThreshold;
        currentDifficultyEl.textContent = currentDifficulty;
        levelProgressEl.textContent = correctInLevel;
        overallScoreEl.textContent = overallScore;
        tenseSelect.disabled = false;
        loadQuestion();
    }

    /**
     * Loads a new verb question based on current difficulty and selected tense.
     */
    function loadQuestion() {
        if (currentDifficulty > maxDifficulty) {
            displayCompletionMessage();
            return;
        }

        currentDifficultyEl.textContent = currentDifficulty;
        levelProgressEl.textContent = correctInLevel;

        let filteredVerbs = verbLibrary.filter(verb => verb.difficulty_level === currentDifficulty);

        if (filteredVerbs.length === 0) {
             console.warn(`No verbs found for difficulty level ${currentDifficulty}.`);
             if (currentDifficulty >= maxDifficulty) {
                 displayCompletionMessage();
             } else {
                 console.log("Attempting to advance level due to empty current level...");
                 currentDifficulty++;
                 correctInLevel = 0;
                 messageArea.textContent = `No verbs found for level ${currentDifficulty-1}. Trying level ${currentDifficulty}.`;
                 loadQuestion();
             }
             return;
        }

        currentVerb = filteredVerbs[Math.floor(Math.random() * filteredVerbs.length)];
        currentTenseField = tenseSelect.value;
        correctOptionValue = currentVerb[currentTenseField] || `N/A (${currentTenseField})`;

        // --- Display Verb Info ---
        verbInfinitiveEl.textContent = currentVerb.infinitive || 'N/A';
        englishMeaningEl.textContent = currentVerb.translation || 'N/A';
        verbDifficultyEl.textContent = currentVerb.difficulty_level !== undefined ? currentVerb.difficulty_level : 'N/A'; // Display verb's difficulty

        if (currentTenseField === 'past_participle') {
            verbInfoEl.textContent = `(Auxiliary: ${currentVerb.auxiliary_verb || 'N/A'})`;
        } else {
            verbInfoEl.textContent = '';
        }
        // --- End Display Verb Info ---


        // --- Option Generation ---
        const options = new Set();
        if (correctOptionValue) {
            options.add(correctOptionValue);
        }
        const numOptions = 5;
        let attempts = 0;
        const maxAttempts = filteredVerbs.length * 2 + 10;

        while (options.size < numOptions && attempts < maxAttempts) {
            const randomVerbIndex = Math.floor(Math.random() * filteredVerbs.length);
            const randomVerb = filteredVerbs[randomVerbIndex];
            const randomOption = randomVerb[currentTenseField];

            if (randomOption && !options.has(randomOption)) {
                options.add(randomOption);
            }
            attempts++;
        }

        const optionsArray = Array.from(options);
        shuffleArray(optionsArray);

        while (optionsArray.length < numOptions) {
            optionsArray.push(`Option ${optionsArray.length + 1}`);
            console.warn("Could not generate enough unique distractors, adding placeholder.");
        }
        if (!optionsArray.includes(correctOptionValue) && correctOptionValue) {
             optionsArray[Math.floor(Math.random() * numOptions)] = correctOptionValue;
        }
        // --- End Option Generation ---


        // --- Display Options ---
        optionsContainer.innerHTML = "";
        optionsArray.forEach((option) => {
            const label = document.createElement("label");
            const radio = document.createElement("input");
            const span = document.createElement("span");

            radio.type = "radio";
            radio.name = "verb-option";
            radio.value = option;
            // Ensure unique ID even if option is 'N/A' or similar
            const safeOptionId = String(option).replace(/[^a-zA-Z0-9-_]/g, '') || `opt-${Math.random().toString(36).substr(2, 9)}`;
            radio.id = `option-${safeOptionId}`;
            radio.addEventListener("change", handleAnswerSelection);

            span.textContent = ` ${option || 'N/A'}`;

            label.htmlFor = radio.id;
            label.appendChild(radio);
            label.appendChild(span);
            optionsContainer.appendChild(label);
        });
        // --- End Display Options ---

        feedbackEl.textContent = "";
        feedbackEl.className = "";
    }

    /**
     * Shuffles array elements in place using Fisher-Yates algorithm.
     * @param {Array} array Array to shuffle.
     */
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    /**
      * Handles the selection of an answer and triggers checking.
      */
    function handleAnswerSelection() {
        checkAnswer();
    }


    /**
     * Checks the selected answer against the correct option.
     */
    function checkAnswer() {
        const selectedOption = document.querySelector('input[name="verb-option"]:checked');
        if (selectedOption) {
            const userAnswer = selectedOption.value;

            if (userAnswer === correctOptionValue) {
                feedbackEl.textContent = "Correct!";
                feedbackEl.className = "correct";
                overallScore++;
                correctInLevel++;
                overallScoreEl.textContent = overallScore;
                levelProgressEl.textContent = correctInLevel;

                if (correctInLevel >= levelThreshold) {
                    if (currentDifficulty < maxDifficulty) {
                        currentDifficulty++;
                        correctInLevel = 0;
                        feedbackEl.textContent += " Level complete! Moving to the next difficulty level!";
                    } else {
                        displayCompletionMessage();
                        return;
                    }
                }
            } else {
                feedbackEl.textContent = `Incorrect. The correct answer is: ${correctOptionValue}`;
                feedbackEl.className = "incorrect";
            }

            document.querySelectorAll('input[name="verb-option"]').forEach(radio => radio.disabled = true);

            if (currentDifficulty <= maxDifficulty) {
                 setTimeout(loadQuestion, 1500);
            }
        }
    }

    /**
     * Displays the completion message when all levels are done.
     */
     function displayCompletionMessage() {
         // Clear the specific question elements first
         verbInfinitiveEl.textContent = "-";
         englishMeaningEl.textContent = "-";
         verbDifficultyEl.textContent = "-"; // Clear verb difficulty too
         verbInfoEl.textContent = "";
         optionsContainer.innerHTML = ""; // Clear options

         // Then update the container with the message
         questionContainer.innerHTML = "<h2>Congratulations! You have completed all available difficulty levels.</h2>";
         tenseSelect.disabled = true;
         feedbackEl.textContent = "Finished!";
         feedbackEl.className = "correct";
     }


    // --- Event Listeners ---
    tenseSelect.addEventListener("change", () => {
        loadQuestion();
    });

    document.addEventListener("DOMContentLoaded", loadVerbLibrary);

</script>

</body>
</html>
